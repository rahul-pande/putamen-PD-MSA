---
title: "R Notebook - putamen subtype clustering"
output:
  pdf_document: default
  # html_notebook: default
---

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = "../")
# knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.retina = T)
```

```{r echo=FALSE, message=FALSE}
library(Seurat)
library(hash)
library(magrittr)
library(dplyr)
library(tidyr)
library(stringi)
library(gplots)
library(flashClust)
library(ape)
library(purrr)
library(cowplot)
library(tibble)
library(ggplot2)
library(scales)
library(lattice)

set.seed(12345)
```


```{r}
data_celltypes <- readRDS("../data/overall_clustered_data/data_celltypes_annotated.rds")

```


Filter Microglia from annotated cells
```{r}
data_microglia <- subset(data_celltypes, idents = "Microglia")

print(as.data.frame(
  table(data_microglia$stim, dnn=list("Group")),
  responseName = c("Count")
  )
)
```

```{r}
DimPlot(data_microglia, reduction = "tsne", group.by = "stim")
DimPlot(data_microglia, reduction = "tsne", group.by = "seurat_clusters")
```


Split and Integrate CTRL, PD and MSA data

```{r echo=FALSE, message=FALSE}

putamen.list <- SplitObject(data_microglia, split.by = "orig.ident")

normAndVarFeatures <- function(seuratObj){
  DefaultAssay(seuratObj) <- "RNA"
  seuratObj <- NormalizeData(seuratObj, verbose=FALSE)
  seuratObj <- FindVariableFeatures(seuratObj, selection.method="vst", nfeatures = 1000, verbose=FALSE)
  return(seuratObj)
}

putamen.list <- lapply(putamen.list, normAndVarFeatures)

k.filter <- min(200, min(sapply(putamen.list, ncol)))

combined.anchors <- FindIntegrationAnchors(
  object.list = putamen.list,
  anchor.features = 1000,
  k.filter = k.filter
)

combined.integrated <- IntegrateData(anchorset = combined.anchors)

```


Dimensionality Reduction
```{r}
cat("combined data default assay: ", DefaultAssay(combined.integrated))
combined.integrated <- ScaleData(combined.integrated, verbose=FALSE)
combined.integrated <- RunPCA(combined.integrated, verbose=FALSE)

combined.integrated
```

Determine number of PC to use for downstream analysis
```{r}
ElbowPlot(combined.integrated, ndims = 40)
```


```{r echo=FALSE}
#Clustering and visualization(using tSNE and UMAP); resolution can vary
combined <- FindNeighbors(combined.integrated, dims = 1:4)
# vary clustering parameter
combined <- RunUMAP(combined, dims = 1:4)
combined <- RunTSNE(combined, dims = 1:4)
```

```{r echo=FALSE}
# vary clustering parameter
DefaultAssay(combined) <- "integrated"
combined <- FindClusters(combined, resolution = 0.1)
```

```{r}
DimPlot(combined, reduction = "umap", group.by = "orig.ident")
DimPlot(combined, reduction = "umap", group.by = "seurat_clusters")
DimPlot(combined, reduction = "umap", split.by = "orig.ident", ncol = 3)
DimPlot(combined, reduction = "umap", split.by = "stim", ncol = 3)
```

```{r}
DimPlot(combined, reduction = "tsne", group.by = "orig.ident")
DimPlot(combined, reduction = "tsne", group.by = "seurat_clusters")
DimPlot(combined, reduction = "tsne", split.by = "orig.ident", ncol = 3)
DimPlot(combined, reduction = "tsne", split.by = "stim", ncol = 3)
```


```{r}
DefaultAssay(combined) <- "RNA"
combined <- ScaleData(combined, verbose = FALSE)
```


```{r warning=F, message=F}
marker.genes <- c("CSF1R", "P2RY12", "CX3CR1", "TYROBP", "CD74",
                  "BCAS1", "OPALIN", "MOBP", "ST18",
                  "MRC1", "TLR4", "MSR1",
                  "CD2", "IL7R", "S100A4")

VlnPlot(subset(combined, stim == "Control"), fill.by = "ident",
        features = marker.genes, stack = T,
        flip = T, assay = "RNA")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
all.markers <- FindAllMarkers(subset(combined, stim == "Control"),
                        logfc.threshold = 0.25, only.pos = T,
                        test.use = "MAST", min.pct = 0.1,
                        assay = "RNA", verbose = F)

write.csv(all.markers, "../data/deg/microglia/control/microglia.cluster.markers.csv", row.names = F)
```


```{r}
table(combined$orig.ident, combined$seurat_clusters)
```


```{R}
VlnPlot(combined,
        features = c("nFeature_RNA", "percent.mt"),
        assay = "RNA", pt.size = 0)
```

```{r}
new.cell.types <- c("MG1",          #- Cluster 0
                    "MG2",          #- Cluster 1
                    "Exclude",      #- Cluster 2
                    "Macrophage",   #- Cluster 3
                    "T-Cell"        #- Cluster 4
)

names(new.cell.types) <- levels(combined)

combined <- RenameIdents(combined, new.cell.types)
combined$cell_type <- Idents(combined)
combined$cluster_annotation <- Idents(combined)

```


```{r}
# saveRDS(combined, "../data/clustered_data/putamen_microglia.rds")
combined <- readRDS("../data/clustered_data/putamen_microglia.rds")
```


Differential Gene Expression

```{r}
for(cluster in c("MG1", "MG2") ){
  inter <- subset(combined, idents = cluster)
  Idents(inter) <- "stim"
  
  for(condition in c("MSA", "PD")){
    de_genes <- FindMarkers(inter, ident.1 = condition, ident.2 = "Control",
                            logfc.threshold = 0.25, assay = "RNA",
                            only.pos = F, min.pct = 0.1, verbose = 5)
    write.csv(de_genes, paste0("../data/deg/microglia/stim/cluster_",
                                    cluster, "_",
                                    condition, "_vs_Control", ".csv")
              )
  }
}
```


```{r}
cell.idents <- data.frame(cluster_id = combined$seurat_clusters,
                          sample_id = combined$orig.ident,
                          group_id = combined$stim,
                          cluster_type = Idents(combined)
                          )

cell.agg <- cell.idents %>%
  group_by(group_id, sample_id) %>%
  mutate(sample_size = length(sample_id)) %>%
  group_by(group_id, sample_id, cluster_type) %>%
  mutate(cluster_size = length(cluster_type)) %>%
  mutate(cluster_proportion = cluster_size/sample_size) %>%
  distinct()

bwplot(cluster_proportion ~ group_id|cluster_type, cell.agg,
       layout=c(5,1), scale = list(x=list(rot=60)))

bwplot(cluster_proportion ~ cluster_type|group_id, cell.agg,
       layout=c(3,1), scale = list(x=list(rot=60)))


dotplot(cluster_proportion ~ group_id|cluster_type, cell.agg,
       layout=c(5,1), scale = list(x=list(rot=60)))

bwplot(paste(cluster_type, group_id, sep = "  ---   ") ~ cluster_proportion, cell.agg)

```





